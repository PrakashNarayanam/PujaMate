<!DOCTYPE html>
<html lang="te">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PujaMate</title>
    <link rel="manifest" href="manifest.json">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Telugu:wght@400;700&display=swap" rel="stylesheet">
    <style>
        .scrollable-select {
            max-height: 200px;
            overflow-y: auto;
        }
        /* Custom styles to refine the Bootstrap theme */
        body {
            font-family: 'Noto Sans Telugu', sans-serif;
            background-color: #f3f4f6;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 1rem;
        }

        .card {
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .card-header {
            background-color: transparent;
            border-bottom: 0;
            text-align: center;
            padding-bottom: 0;
        }
        
        .card-title {
            font-size: 1.875rem;
            font-weight: 700;
            color: #4338ca;
        }

        .form-control, .form-select {
            border-radius: 0.5rem;
            background-color: #f9fafb;
            border-color: #d1d5db;
        }
        
        .form-control:focus, .form-select:focus {
            border-color: #4338ca;
            box-shadow: 0 0 0 0.25rem rgba(67, 56, 202, 0.25);
        }
        
        .list-group-item {
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
            background-color: #f9fafb;
        }
        #samagriList {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .btn-primary {
            background-color: #4338ca;
            border-color: #4338ca;
        }
        
        .btn-primary:hover {
            background-color: #3730a3;
            border-color: #3730a3;
        }
        
        .btn-success {
            background-color: #10b981;
            border-color: #10b981;
        }
        
        .btn-success:hover {
            background-color: #059669;
            border-color: #059669;
        }

        .btn-secondary {
            background-color: #6b7280;
            border-color: #6b7280;
        }
        
        .btn-secondary:hover {
            background-color: #4b5563;
            border-color: #4b5563;
        }
    </style>
</head>
<body>

<div class="container my-5" style="max-width: 600px;">
    <div class="card p-4" id="mainPanel">
        <div class="mb-3">
            <a href="index.html" class="btn btn-outline-primary">üè† ‡∞π‡±ã‡∞Æ‡±ç‚Äå</a>
        </div>
        <div class="card-header">
            <h1 class="card-title">ü™î ‡∞™‡±Ç‡∞ú‡∞æ ‡∞∏‡∞æ‡∞Æ‡∞ó‡±ç‡∞∞‡∞ø ‡∞ú‡∞æ‡∞¨‡∞ø‡∞§‡∞æ</h1>
        </div>
        <div class="card-body">
            <div class="mb-3">
                <label for="pujaSelect" class="form-label fw-bold text-muted">‡∞™‡±Ç‡∞ú‡∞æ ‡∞∞‡∞ï‡∞Ç ‡∞é‡∞Ç‡∞ö‡±Å‡∞ï‡±ã‡∞Ç‡∞°‡∞ø:</label>
                <select class="form-select" id="pujaSelect"></select>
            </div>

            <ul class="list-group" id="samagriList"></ul>

            <div class="d-grid gap-2 d-md-block mt-4">
                <div class="row g-2">
                    <div class="col-12 col-md">
                        <button class="btn btn-primary w-100" onclick="copyList()">üìã ‡∞ï‡∞æ‡∞™‡±Ä</button>
                    </div>
                    <div class="col-12 col-md">
                        <button class="btn btn-secondary w-100" onclick="shareList()">üì§ ‡∞∑‡±á‡∞∞‡±ç</button>
                    </div>
                    <div class="col-12 col-md">
                        <button class="btn btn-primary w-100" onclick="editMode()">‚úè ‡∞é‡∞°‡∞ø‡∞ü‡±ç</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="card p-4 mt-4" id="editPanel" style="display:none;">
        <div class="card-header">
            <h2 class="card-title">‚úè ‡∞™‡±Ç‡∞ú‡∞æ ‡∞µ‡∞ø‡∞µ‡∞∞‡∞æ‡∞≤‡±Å ‡∞é‡∞°‡∞ø‡∞ü‡±ç ‡∞ö‡±á‡∞Ø‡∞Ç‡∞°‡∞ø</h2>
        </div>
        <div class="card-body">
            <div class="mb-3">
                <label for="editPujaName" class="form-label fw-bold text-muted">‡∞™‡±Ç‡∞ú‡∞æ ‡∞™‡±á‡∞∞‡±Å:</label>
                <input type="text" class="form-control" id="editPujaName" placeholder="‡∞ï‡±ä‡∞§‡±ç‡∞§ ‡∞™‡±Ç‡∞ú‡∞æ ‡∞™‡±á‡∞∞‡±Å">
            </div>

            <div class="mb-3">
                <label for="editItem" class="form-label fw-bold text-muted">‡∞ï‡±ä‡∞§‡±ç‡∞§ ‡∞∏‡∞æ‡∞Æ‡∞ó‡±ç‡∞∞‡∞ø ‡∞ö‡±á‡∞∞‡±ç‡∞ö‡±Å:</label>
                <div class="input-group mb-2">
                    <input type="text" class="form-control" id="editItem" placeholder="‡∞∏‡∞æ‡∞Æ‡∞ó‡±ç‡∞∞‡∞ø ‡∞™‡±á‡∞∞‡±Å">
                    <input type="number" class="form-control" id="editQuantity" placeholder="‡∞∏‡∞Ç‡∞ñ‡±ç‡∞Ø" style="max-width: 80px;" value="1">
                    <select class="form-select" id="editUnit" style="max-width: 100px;">
                        <option value="none">none</option>
                        <option value="‡∞∏‡∞Ç‡∞ñ‡±ç‡∞Ø">‡∞∏‡∞Ç‡∞ñ‡±ç‡∞Ø</option>
                        <option value="‡∞ï‡∞ø‡∞≤‡±ã">‡∞ï‡∞ø‡∞≤‡±ã</option>
                        <option value="‡∞ó‡±ç‡∞∞‡∞æ‡∞Æ‡±Å">‡∞ó‡±ç‡∞∞‡∞æ‡∞Æ‡±Å</option>
                        <option value="‡∞Æ‡±Ä‡∞ü‡∞∞‡±ç">‡∞Æ‡±Ä‡∞ü‡∞∞‡±ç</option>
                        <option value="‡∞°‡∞ú‡∞®‡±Å">‡∞°‡∞ú‡∞®‡±Å</option>
                        <option value="‡∞≤‡±Ä‡∞ü‡∞∞‡±ç">‡∞≤‡±Ä‡∞ü‡∞∞‡±ç</option>
                        <option value="‡∞ú‡∞§">‡∞ú‡∞§</option>
                        <option value="‡∞™‡±ç‡∞Ø‡∞æ‡∞ï‡±Ü‡∞ü‡±ç">‡∞™‡±ç‡∞Ø‡∞æ‡∞ï‡±Ü‡∞ü‡±ç</option>
                        <option value="‡∞°‡∞¨‡±ç‡∞¨‡∞æ">‡∞°‡∞¨‡±ç‡∞¨‡∞æ</option>
                    </select>
                    <button class="btn btn-primary" type="button" onclick="addItem()">+</button>
                </div>
                <div class="mt-2">
                    <label for="bulkItems" class="form-label text-muted">‡∞í‡∞ï‡±á‡∞∏‡∞æ‡∞∞‡∞ø ‡∞Ö‡∞®‡±á‡∞ï ‡∞∏‡∞æ‡∞Æ‡∞ó‡±ç‡∞∞‡∞ø ‡∞ö‡±á‡∞∞‡±ç‡∞ö‡∞Ç‡∞°‡∞ø (‡∞™‡±ç‡∞∞‡∞§‡∞ø ‡∞≤‡±à‡∞®‡±ç ‡∞í‡∞ï ‡∞∏‡∞æ‡∞Æ‡∞ó‡±ç‡∞∞‡∞ø):</label>
                    <textarea class="form-control" id="bulkItems" rows="2" placeholder="‡∞â‡∞¶‡∞æ: ‡∞ï‡±ä‡∞¨‡±ç‡∞¨‡∞∞‡∞ø‡∞ï‡∞æ‡∞Ø\n‡∞™‡∞∏‡±Å‡∞™‡±Å\n‡∞ï‡±Å‡∞Ç‡∞ï‡±Å‡∞Æ"></textarea>
                    <button class="btn btn-success mt-2" type="button" onclick="addBulkItems()">‡∞¨‡∞≤‡±ç‡∞ï‡±ç ‡∞ö‡±á‡∞∞‡±ç‡∞ö‡±Å</button>
                </div>
            </div>

            <label class="form-label fw-bold text-muted">‡∞™‡±ç‡∞∞‡∞∏‡±ç‡∞§‡±Å‡∞§ ‡∞∏‡∞æ‡∞Æ‡∞ó‡±ç‡∞∞‡∞ø:</label>
            <ul class="list-group mb-3" id="editList"></ul>

            <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
                <button class="btn btn-danger me-md-auto" id="deleteButton" onclick="deletePuja()">‡∞™‡±Ç‡∞ú‡∞æ ‡∞§‡±ä‡∞≤‡∞ó‡∞ø‡∞Ç‡∞ö‡∞Ç‡∞°‡∞ø</button>
                <button class="btn btn-secondary" onclick="cancelEdit()">‡∞∞‡∞¶‡±ç‡∞¶‡±Å ‡∞ö‡±á‡∞Ø‡∞ø</button>
                <button class="btn btn-success" onclick="saveChanges()">üíæ ‡∞∏‡±á‡∞µ‡±ç</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
function addBulkItems() {
    let puja = document.getElementById("editPujaName").value;
    let bulkText = document.getElementById("bulkItems").value.trim();
    if (!bulkText) return;
    if (!pujaData[puja]) pujaData[puja] = [];
    let lines = bulkText.split(/\r?\n/);
    lines.forEach(line => {
        let itemName = line.trim();
        if (!itemName) return;
        let translatedItem = englishToTeluguMap[itemName] || transliterationMap[itemName] || itemName;
        pujaData[puja].push({ name: translatedItem, quantity: 1, unit: 'none' });
    });
    document.getElementById("bulkItems").value = "";
    renderEditList();
}
let pujaData = {};
let originalPujaData = {};

// Fetch data from puja.json and initialize dropdown
async function fetchAndInitPujaData() {
    try {
        const response = await fetch('puja.json');
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        pujaData = await response.json();
        populatePujaSelect();
    } catch (e) {
        console.error('Error fetching puja.json:', e);
        document.getElementById('pujaSelect').innerHTML = '<option>‡∞°‡±á‡∞ü‡∞æ ‡∞≤‡±ã‡∞™‡∞Ç</option>';
    }
}

// Helper function to transliterate from English
const englishToTeluguMap = {
    "coconut": "‡∞ï‡±ä‡∞¨‡±ç‡∞¨‡∞∞‡∞ø‡∞ï‡∞æ‡∞Ø", "jaggery": "‡∞¨‡±Ü‡∞≤‡±ç‡∞≤‡∞Ç", "banana": "‡∞Ö‡∞∞‡∞ü‡∞ø‡∞™‡∞Ç‡∞°‡±Å", "turmeric": "‡∞™‡∞∏‡±Å‡∞™‡±Å", "kumkum": "‡∞ï‡±Å‡∞Ç‡∞ï‡±Å‡∞Æ",
    "milk": "‡∞™‡∞æ‡∞≤‡±Å", "sugarcane": "‡∞ö‡±Ü‡∞∞‡∞ï‡±Å", "clothes": "‡∞ï‡±ä‡∞§‡±ç‡∞§ ‡∞¶‡±Å‡∞∏‡±ç‡∞§‡±Å‡∞≤‡±Å", "lamp": "‡∞¶‡±Ä‡∞™‡∞Ç", "incense": "‡∞∏‡±Å‡∞ó‡∞Ç‡∞ß ‡∞¶‡±ç‡∞∞‡∞µ‡±ç‡∞Ø‡∞æ‡∞≤‡±Å",
    "flowers": "‡∞™‡±Ç‡∞≤‡±Å", "betel leaves": "‡∞§‡∞Æ‡∞≤‡∞™‡∞æ‡∞ï‡±Å‡∞≤‡±Å", "betel nut": "‡∞µ‡∞ï‡±ç‡∞ï‡∞≤‡±Å", "rice": "‡∞¨‡∞ø‡∞Ø‡±ç‡∞Ø‡∞Ç", "ghee": "‡∞®‡±Ü‡∞Ø‡±ç‡∞Ø‡∞ø",
    "camphor": "‡∞ï‡∞∞‡±ç‡∞™‡±Ç‡∞∞‡∞Ç", "agarbatti": "‡∞Ö‡∞ó‡∞∞‡∞¨‡∞§‡±ç‡∞§‡∞ø", "matches": "‡∞Ö‡∞ó‡±ç‡∞ó‡∞ø‡∞™‡±Ü‡∞ü‡±ç‡∞ü‡±Ü", "cotton": "‡∞™‡∞§‡±ç‡∞§‡∞ø", "oil": "‡∞®‡±Ç‡∞®‡±Ü",
    "water": "‡∞®‡±Ä‡∞∞‡±Å", "sandalwood": "‡∞ó‡∞Ç‡∞ß‡∞Ç", "chandan": "‡∞ö‡∞Ç‡∞¶‡∞®‡∞Ç", "akshata": "‡∞Ö‡∞ï‡±ç‡∞∑‡∞§‡∞≤‡±Å", "coins": "‡∞®‡∞æ‡∞£‡±Ü‡∞Æ‡±Å‡∞≤‡±Å",
    "kalasha": "‡∞ï‡∞≤‡∞∂‡∞Ç", "mango leaves": "‡∞Æ‡∞æ‡∞Æ‡∞ø‡∞°‡∞ø ‡∞Ü‡∞ï‡±Å‡∞≤‡±Å", "sugar": "‡∞™‡∞Ç‡∞ö‡∞¶‡∞æ‡∞∞", "honey": "‡∞§‡±á‡∞®‡±Ü", "dhoop": "‡∞ß‡±Ç‡∞™‡∞Ç",
    "bhajanam": "‡∞≠‡∞ú‡∞®‡∞™‡∞æ‡∞§‡±ç‡∞∞", "bell": "‡∞ó‡∞Ç‡∞ü", "plate": "‡∞™‡∞≥‡±ç‡∞≥‡±Ü‡∞Ç", "spoon": "‡∞ö‡±Ü‡∞Ç‡∞ö‡∞æ", "gram": "‡∞ó‡±ç‡∞∞‡∞æ‡∞Æ‡±Å", "packet": "‡∞™‡±ç‡∞Ø‡∞æ‡∞ï‡±Ü‡∞ü‡±ç", "dabba": "‡∞°‡∞¨‡±ç‡∞¨‡∞æ"
};

const transliterationMap = {
    "kobbari": "‡∞ï‡±ä‡∞¨‡±ç‡∞¨‡∞∞‡∞ø‡∞ï‡∞æ‡∞Ø", "bellam": "‡∞¨‡±Ü‡∞≤‡±ç‡∞≤‡∞Ç", "aratipandu": "‡∞Ö‡∞∞‡∞ü‡∞ø‡∞™‡∞Ç‡∞°‡±Å", "pasupu": "‡∞™‡∞∏‡±Å‡∞™‡±Å", "kumkuma": "‡∞ï‡±Å‡∞Ç‡∞ï‡±Å‡∞Æ",
    "palu": "‡∞™‡∞æ‡∞≤‡±Å", "cheruku": "‡∞ö‡±Ü‡∞∞‡∞ï‡±Å", "kottadusthulu": "‡∞ï‡±ä‡∞§‡±ç‡∞§ ‡∞¶‡±Å‡∞∏‡±ç‡∞§‡±Å‡∞≤‡±Å", "deepam": "‡∞¶‡±Ä‡∞™‡∞Ç", "sugandhadravyalu": "‡∞∏‡±Å‡∞ó‡∞Ç‡∞ß ‡∞¶‡±ç‡∞∞‡∞µ‡±ç‡∞Ø‡∞æ‡∞≤‡±Å",
    "poolu": "‡∞™‡±Ç‡∞≤‡±Å", "tamalapaakulu": "‡∞§‡∞Æ‡∞≤‡∞™‡∞æ‡∞ï‡±Å‡∞≤‡±Å", "vakkalu": "‡∞µ‡∞ï‡±ç‡∞ï‡∞≤‡±Å", "biyyam": "‡∞¨‡∞ø‡∞Ø‡±ç‡∞Ø‡∞Ç", "neyyi": "‡∞®‡±Ü‡∞Ø‡±ç‡∞Ø‡∞ø",
    "karpooram": "‡∞ï‡∞∞‡±ç‡∞™‡±Ç‡∞∞‡∞Ç", "agarbatti": "‡∞Ö‡∞ó‡∞∞‡∞¨‡∞§‡±ç‡∞§‡∞ø", "aggipette": "‡∞Ö‡∞ó‡±ç‡∞ó‡∞ø‡∞™‡±Ü‡∞ü‡±ç‡∞ü‡±Ü", "patti": "‡∞™‡∞§‡±ç‡∞§‡∞ø", "noone": "‡∞®‡±Ç‡∞®‡±Ü",
    "neeru": "‡∞®‡±Ä‡∞∞‡±Å", "gandham": "‡∞ó‡∞Ç‡∞ß‡∞Ç", "chandanam": "‡∞ö‡∞Ç‡∞¶‡∞®‡∞Ç", "akshatalu": "‡∞Ö‡∞ï‡±ç‡∞∑‡∞§‡∞≤‡±Å", "naanemulu": "‡∞®‡∞æ‡∞£‡±Ü‡∞Æ‡±Å‡∞≤‡±Å",
    "kalasham": "‡∞ï‡∞≤‡∞∂‡∞Ç", "mamidi": "‡∞Æ‡∞æ‡∞Æ‡∞ø‡∞°‡∞ø ‡∞Ü‡∞ï‡±Å‡∞≤‡±Å", "panchadara": "‡∞™‡∞Ç‡∞ö‡∞¶‡∞æ‡∞∞", "thene": "‡∞§‡±á‡∞®‡±Ü", "dhoopam": "‡∞ß‡±Ç‡∞™‡∞Ç",
    "bhajanapatra": "‡∞≠‡∞ú‡∞®‡∞™‡∞æ‡∞§‡±ç‡∞∞", "ganta": "‡∞ó‡∞Ç‡∞ü", "pallem": "‡∞™‡∞≥‡±ç‡∞≥‡±Ü‡∞Ç", "chencha": "‡∞ö‡±Ü‡∞Ç‡∞ö‡∞æ", "gramu": "‡∞ó‡±ç‡∞∞‡∞æ‡∞Æ‡±Å", "packet": "‡∞™‡±ç‡∞Ø‡∞æ‡∞ï‡±Ü‡∞ü‡±ç", "dabba": "‡∞°‡∞¨‡±ç‡∞¨‡∞æ"
};

function populatePujaSelect() {
    let select = document.getElementById("pujaSelect");
    select.innerHTML = "";
    const pujaKeys = Object.keys(pujaData);
    pujaKeys.forEach(puja => {
        let option = document.createElement("option");
        option.value = puja;
        option.textContent = puja;
        select.appendChild(option);
    });
    let newPujaOption = document.createElement("option");
    newPujaOption.value = "new-puja";
    newPujaOption.textContent = "‡∞ï‡±ä‡∞§‡±ç‡∞§ ‡∞™‡±Ç‡∞ú‡∞æ ‡∞∞‡∞ï‡∞Ç ‡∞ö‡±á‡∞∞‡±ç‡∞ö‡±Å";
    select.appendChild(newPujaOption);
    // Toggle scrollable class if more than 6 puja types
    if (pujaKeys.length > 6) {
        select.classList.add('scrollable-select');
    } else {
        select.classList.remove('scrollable-select');
    }
    showSamagri();
}

function showSamagri() {
    let puja = document.getElementById("pujaSelect").value;
    if (puja === "new-puja") {
        editMode(true);
        return;
    }
    let list = document.getElementById("samagriList");
    list.innerHTML = "";
    (pujaData[puja] || []).forEach(item => {
        let li = document.createElement("li");
        li.className = "list-group-item d-flex justify-content-between align-items-center";
        let displayUnit = item.unit === 'none' ? '' : `${item.quantity} ${item.unit}`;
        li.innerHTML = `
            <span>${item.name}</span>
            <span class="badge bg-primary rounded-pill">${displayUnit}</span>
        `;
        list.appendChild(li);
    });
}

function copyList() {
    let puja = document.getElementById("pujaSelect").value;
    let text = `${puja}:\n`;
    (pujaData[puja] || []).forEach(item => {
        let displayUnit = item.unit === 'none' ? '' : ` - ${item.quantity} ${item.unit}`;
        text += `${item.name}${displayUnit}\n`;
    });
    // navigator.clipboard.writeText(text);
    // Use execCommand for better cross-browser support, especially in iframes
    const tempInput = document.createElement('textarea');
    tempInput.value = text;
    document.body.appendChild(tempInput);
    tempInput.select();
    document.execCommand('copy');
    document.body.removeChild(tempInput);

    alert("‡∞ï‡∞æ‡∞™‡±Ä ‡∞Ö‡∞Ø‡±ç‡∞Ø‡∞ø‡∞Ç‡∞¶‡∞ø!");
}

function shareList() {
    let puja = document.getElementById("pujaSelect").value;
    let text = `${puja}:\n`;
    (pujaData[puja] || []).forEach(item => {
        let displayUnit = item.unit === 'none' ? '' : ` - ${item.quantity} ${item.unit}`;
        text += `${item.name}${displayUnit}\n`;
    });
    if (navigator.share) {
        navigator.share({ text: text, title: '‡∞™‡±Ç‡∞ú‡∞æ ‡∞∏‡∞æ‡∞Æ‡∞ó‡±ç‡∞∞‡∞ø ‡∞ú‡∞æ‡∞¨‡∞ø‡∞§‡∞æ' });
    } else {
        alert("‡∞Æ‡±Ä ‡∞¨‡±ç‡∞∞‡±å‡∞ú‡∞∞‡±ç ‡∞∑‡±á‡∞∞‡±ç ‡∞∏‡∞™‡±ã‡∞∞‡±ç‡∞ü‡±ç ‡∞ö‡±á‡∞Ø‡∞¶‡±Å.");
    }
}

function editMode(isNew = false) {
    // Create a deep copy of the current data in case the user cancels
    originalPujaData = JSON.parse(JSON.stringify(pujaData));

    document.getElementById("mainPanel").style.display = "none";
    document.getElementById("editPanel").style.display = "block";
    
    if (isNew) {
        document.getElementById("editPujaName").value = "";
        document.getElementById("deleteButton").style.display = "none";
        document.getElementById("editPujaName").placeholder = "‡∞ï‡±ä‡∞§‡±ç‡∞§ ‡∞™‡±Ç‡∞ú‡∞æ ‡∞™‡±á‡∞∞‡±Å";
        document.getElementById("editPujaName").disabled = false;
        document.getElementById("editItem").value = "";
        document.getElementById("editQuantity").value = 1;
        document.getElementById("editList").innerHTML = "";
    } else {
        document.getElementById("editPujaName").value = document.getElementById("pujaSelect").value;
        document.getElementById("deleteButton").style.display = "block";
        document.getElementById("editPujaName").disabled = false;
        renderEditList();
    }
}

function cancelEdit() {
    // Restore the pujaData from the backup
    pujaData = originalPujaData;
    sessionStorage.setItem("pujaData", JSON.stringify(pujaData));

    // Switch back to the main view
    document.getElementById("editPanel").style.display = "none";
    document.getElementById("mainPanel").style.display = "block";
    populatePujaSelect();
}

function renderEditList() {
    let puja = document.getElementById("editPujaName").value;
    let listDiv = document.getElementById("editList");
    listDiv.innerHTML = "";
    (pujaData[puja] || []).forEach((item, idx) => {
        let li = document.createElement("li");
        li.className = "list-group-item d-flex justify-content-between align-items-center";
        li.innerHTML = `
            <span>${item.name}</span>
            <div class="d-flex align-items-center">
                <input type="number" class="form-control me-2" style="width: 80px;" value="${item.quantity}" data-index="${idx}" data-field="quantity">
                <select class="form-select me-2" style="width: 100px;" data-index="${idx}" data-field="unit">
                    <option value="none" ${item.unit === 'none' ? 'selected' : ''}>none</option>
                    <option value="‡∞∏‡∞Ç‡∞ñ‡±ç‡∞Ø" ${item.unit === '‡∞∏‡∞Ç‡∞ñ‡±ç‡∞Ø' ? 'selected' : ''}>‡∞∏‡∞Ç‡∞ñ‡±ç‡∞Ø</option>
                    <option value="‡∞ï‡∞ø‡∞≤‡±ã" ${item.unit === '‡∞ï‡∞ø‡∞≤‡±ã' ? 'selected' : ''}>‡∞ï‡∞ø‡∞≤‡±ã</option>
                    <option value="‡∞ó‡±ç‡∞∞‡∞æ‡∞Æ‡±Å" ${item.unit === '‡∞ó‡±ç‡∞∞‡∞æ‡∞Æ‡±Å' ? 'selected' : ''}>‡∞ó‡±ç‡∞∞‡∞æ‡∞Æ‡±Å</option>
                    <option value="‡∞Æ‡±Ä‡∞ü‡∞∞‡±ç" ${item.unit === '‡∞Æ‡±Ä‡∞ü‡∞∞‡±ç' ? 'selected' : ''}>‡∞Æ‡±Ä‡∞ü‡∞∞‡±ç</option>
                    <option value="‡∞°‡∞ú‡∞®‡±Å" ${item.unit === '‡∞°‡∞ú‡∞®‡±Å' ? 'selected' : ''}>‡∞°‡∞ú‡∞®‡±Å</option>
                    <option value="‡∞≤‡±Ä‡∞ü‡∞∞‡±ç" ${item.unit === '‡∞≤‡±Ä‡∞ü‡∞∞‡±ç' ? 'selected' : ''}>‡∞≤‡±Ä‡∞ü‡∞∞‡±ç</option>
                    <option value="‡∞ú‡∞§" ${item.unit === '‡∞ú‡∞§' ? 'selected' : ''}>‡∞ú‡∞§</option>
                    <option value="‡∞™‡±ç‡∞Ø‡∞æ‡∞ï‡±Ü‡∞ü‡±ç" ${item.unit === '‡∞™‡±ç‡∞Ø‡∞æ‡∞ï‡±Ü‡∞ü‡±ç' ? 'selected' : ''}>‡∞™‡±ç‡∞Ø‡∞æ‡∞ï‡±Ü‡∞ü‡±ç</option>
                    <option value="‡∞°‡∞¨‡±ç‡∞¨‡∞æ" ${item.unit === '‡∞°‡∞¨‡±ç‡∞¨‡∞æ' ? 'selected' : ''}>‡∞°‡∞¨‡±ç‡∞¨‡∞æ</option>
                </select>
                <button class="btn btn-link text-danger" onclick="removeItem(${idx})">‚ùå</button>
            </div>
        `;
        listDiv.appendChild(li);
    });
}

function addItem() {
    let puja = document.getElementById("editPujaName").value;
    let itemInput = document.getElementById("editItem").value.trim().toLowerCase();
    let quantityInput = document.getElementById("editQuantity").value;
    let unitInput = document.getElementById("editUnit").value;
    
    if (!pujaData[puja]) {
        pujaData[puja] = [];
    }

    if (itemInput) {
        let translatedItem = englishToTeluguMap[itemInput];
        
        if (!translatedItem) {
            translatedItem = transliterationMap[itemInput];
        }

        if (!translatedItem) {
            translatedItem = itemInput;
        }

        const newItem = {
            name: translatedItem,
            quantity: parseInt(quantityInput) || 1,
            unit: unitInput
        };

        pujaData[puja].push(newItem);
        document.getElementById("editItem").value = "";
        document.getElementById("editQuantity").value = 1;
        renderEditList();
    }
}

function removeItem(index) {
    let puja = document.getElementById("editPujaName").value;
    if (pujaData[puja]) {
        pujaData[puja].splice(index, 1);
        renderEditList();
    }
}

function deletePuja() {
    let puja = document.getElementById("editPujaName").value;
    if (confirm(`‡∞Æ‡±Ä‡∞∞‡±Å ${puja} ‡∞®‡±Å ‡∞§‡±ä‡∞≤‡∞ó‡∞ø‡∞Ç‡∞ö‡∞æ‡∞≤‡∞®‡±Å‡∞ï‡±Å‡∞Ç‡∞ü‡±Å‡∞®‡±ç‡∞®‡∞æ‡∞∞‡∞æ?`)) {
        delete pujaData[puja];
        saveChanges();
    }
}

function saveChanges() {
    let pujaName = document.getElementById("editPujaName").value.trim();
    if (pujaName === "") {
        alert("‡∞¶‡∞Ø‡∞ö‡±á‡∞∏‡∞ø ‡∞™‡±Ç‡∞ú‡∞æ ‡∞∞‡∞ï‡∞Ç ‡∞™‡±á‡∞∞‡±Å ‡∞á‡∞µ‡±ç‡∞µ‡∞Ç‡∞°‡∞ø.");
        return;
    }

    let oldPujaName = document.getElementById("pujaSelect").value;
    let newItems = [];
    let listItems = document.getElementById("editList").querySelectorAll('.list-group-item');

    listItems.forEach(itemEl => {
        let name = itemEl.querySelector('span').textContent;
        let quantity = parseInt(itemEl.querySelector('input').value) || 1;
        let unit = itemEl.querySelector('select').value;
        newItems.push({ name: name, quantity: quantity, unit: unit });
    });

    if (oldPujaName !== "new-puja" && oldPujaName !== pujaName) {
        delete pujaData[oldPujaName];
    }
    
    pujaData[pujaName] = newItems;

    sessionStorage.setItem("pujaData", JSON.stringify(pujaData));
    document.getElementById("editPanel").style.display = "none";
    document.getElementById("mainPanel").style.display = "block";
    populatePujaSelect();
}

// Initial app load
fetchAndInitPujaData();
document.getElementById("pujaSelect").addEventListener("change", showSamagri);
</script>

<script>
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('/service-worker.js')
                .then(registration => {
                    console.log('Service Worker registered with scope:', registration.scope);
                })
                .catch(err => {
                    console.log('Service Worker registration failed:', err);
                });
        });
    }
</script>
</body>
</html>
